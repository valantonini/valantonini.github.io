<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="A blog about all things programming by val antonini.">
    <title>Creating views from enums with DbUp</title>
    <link rel="canonical" href="https://valantonini.com/2014/12/30">
    <!-- Custom CSS -->

    <link rel="icon" href="https://valantonini.com/images/favicon.png">

    <!--<script src="https://valantonini.com/bower_components/jquery/dist/jquery.min.js"></script>-->
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>if (!window.jQuery) {
    var localjQuery = 'https://valantonini.com/bower_components/jquery/dist/jquery.min.js';
    var localjQueryScript = '<script src="'+localjQuery+'"><\/script>';
    document.write(localjQueryScript);
}
</script>
    <!-- website by valantonini -->
     <!--Background pattern from subtlepatterns.com -->
</head>


<body>
<div class="arakawa-bg">
    <div class="container">
        <nav class="navbar navbar-default navbar-static-top/Users/val/Downloads/paper_fibers/paper_fibers.png">
    <div class="container">

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://valantonini.com">
                <img src="https://valantonini.com/images/logo.png" alt="arakawa icon" class="logo">
                valantonini.com
            </a>
        </div>

        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
                        Posts<span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu" role="menu">
                        <li><a href="https://valantonini.com/posts/" title="all posts">All Posts</a></li>
                        <li><a href="https://valantonini.com/categories/" title="categories">Categories</a></li>
                        <li><a href="https://valantonini.com/tags/" title="tags">Tags</a></li>
                        <li><a href="https://valantonini.com/search/" title="search">Search</a></li>
                    </ul>
                </li>
                <li>
                    <a href="https://valantonini.com/about" title="About Me">About</a>
                </li>
                <li>
                    <a href="https://valantonini.com/contact" title="Contact Me">Contact</a>
                </li>
            </ul>
        </div>

    </div>
</nav>

        <div class="content">
            <div class="row">
                <div class="col-md-12">
                    <div class="post">

    <header>
        <h1>Creating views from enums with DbUp</h1>

        <p class="meta">
            Dec 30, 2014 â€¢ val antonini
        </p>
    </header>

    <article>
        <p>
    <a href="http://dbup.github.io/" title="dbup" target="_blank">DbUp</a> is a great script runner for handling database migrations.
    This snippet can be used to can an assembly and create views for any public enums inside it. The assembly version needs to
    be incremented for views to be recreated
</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">valantonini</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">UpgradeEngineBuilderExtensions</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">static</span> <span class="n">UpgradeEngineBuilder</span> <span class="nf">GenerateLookupViewsForEnumsIn</span><span class="p">(</span><span class="k">this</span> <span class="n">UpgradeEngineBuilder</span> <span class="n">builder</span><span class="p">,</span> <span class="n">Assembly</span> <span class="n">assembly</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">enumLookupScriptProvider</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EnumLookupScriptProvider</span><span class="p">(</span><span class="n">assembly</span><span class="p">);</span>
            <span class="n">builder</span><span class="p">.</span><span class="nf">Configure</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">ScriptProviders</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">enumLookupScriptProvider</span><span class="p">));</span>
            <span class="k">return</span> <span class="n">builder</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">EnumLookupScriptProvider</span> <span class="p">:</span> <span class="n">IScriptProvider</span>
    <span class="p">{</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">DropView</span> <span class="p">=</span> <span class="s">"IF EXISTS(select * FROM sys.views where name = \'{0}\')\n DROP VIEW {0}\n GO\n"</span><span class="p">;</span>
        <span class="k">private</span> <span class="k">const</span> <span class="kt">string</span> <span class="n">CreateView</span> <span class="p">=</span> <span class="s">"CREATE VIEW {0} AS {1}\n GO\n"</span><span class="p">;</span>

        <span class="k">private</span> <span class="k">readonly</span> <span class="n">Assembly</span> <span class="n">_assembly</span><span class="p">;</span>

        <span class="k">public</span> <span class="nf">EnumLookupScriptProvider</span><span class="p">(</span><span class="n">Assembly</span> <span class="n">assembly</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">_assembly</span> <span class="p">=</span> <span class="n">assembly</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">SqlScript</span><span class="p">&gt;</span> <span class="nf">GetScripts</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">IDbConnection</span><span class="p">&gt;</span> <span class="n">connectionFactory</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">enumTypes</span> <span class="p">=</span> <span class="n">_assembly</span>
            <span class="p">.</span><span class="n">DefinedTypes</span>
            <span class="p">.</span><span class="nf">Where</span><span class="p">(</span><span class="n">type</span> <span class="p">=&gt;</span> <span class="n">type</span><span class="p">.</span><span class="n">IsEnum</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">scripts</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">SqlScript</span><span class="p">&gt;();</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">type</span> <span class="k">in</span> <span class="n">enumTypes</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">dropViewScript</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">DropView</span><span class="p">,</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">createViewScript</span> <span class="p">=</span> <span class="nf">GenerateCreateView</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">script</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0} {1}"</span><span class="p">,</span> <span class="n">dropViewScript</span><span class="p">,</span> <span class="n">createViewScript</span><span class="p">);</span>

                <span class="kt">var</span> <span class="n">scriptName</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="s">"{0}-{1}"</span><span class="p">,</span><span class="n">type</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span><span class="n">_assembly</span><span class="p">.</span><span class="nf">GetName</span><span class="p">().</span><span class="n">Version</span><span class="p">);</span>
                <span class="n">scripts</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">SqlScript</span><span class="p">(</span><span class="n">scriptName</span><span class="p">,</span> <span class="n">script</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">scripts</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">private</span> <span class="kt">string</span> <span class="nf">GenerateCreateView</span><span class="p">(</span><span class="n">TypeInfo</span> <span class="n">type</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">const</span> <span class="kt">string</span> <span class="n">selectStatementFormat</span> <span class="p">=</span> <span class="s">"SELECT {0} AS Id, \'{1}\' AS Value"</span><span class="p">;</span>
            <span class="kt">var</span> <span class="n">selectStatements</span> <span class="p">=</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;();</span>
            <span class="kt">var</span> <span class="n">enumValues</span> <span class="p">=</span> <span class="n">Enum</span><span class="p">.</span><span class="nf">GetValues</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">enumValue</span> <span class="k">in</span> <span class="n">enumValues</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">var</span> <span class="n">castValue</span> <span class="p">=</span> <span class="n">enumValue</span> <span class="k">as</span> <span class="n">Enum</span><span class="p">;</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">castValue</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

                <span class="kt">var</span> <span class="n">selectStatement</span> <span class="p">=</span> <span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">selectStatementFormat</span><span class="p">,</span> <span class="n">castValue</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="s">"d"</span><span class="p">),</span> <span class="nf">GetDescription</span><span class="p">(</span><span class="n">castValue</span><span class="p">).</span><span class="nf">Replace</span><span class="p">(</span><span class="s">"'"</span><span class="p">,</span> <span class="s">"''"</span><span class="p">));</span>
                <span class="n">selectStatements</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="n">selectStatement</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">String</span><span class="p">.</span><span class="nf">Format</span><span class="p">(</span><span class="n">CreateView</span><span class="p">,</span> <span class="n">type</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">String</span><span class="p">.</span><span class="nf">Join</span><span class="p">(</span><span class="s">"\nUNION\n"</span><span class="p">,</span> <span class="n">selectStatements</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">GetDescription</span><span class="p">(</span><span class="n">Enum</span> <span class="n">e</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="kt">var</span> <span class="n">field</span> <span class="p">=</span> <span class="n">e</span><span class="p">.</span><span class="nf">GetType</span><span class="p">().</span><span class="nf">GetField</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="nf">ToString</span><span class="p">());</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="p">==</span> <span class="k">null</span><span class="p">)</span> <span class="k">return</span> <span class="n">e</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>

            <span class="kt">var</span> <span class="n">description</span> <span class="p">=</span> <span class="n">field</span><span class="p">.</span><span class="nf">GetCustomAttributes</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">DescriptionAttribute</span><span class="p">),</span> <span class="k">false</span><span class="p">)</span>
            <span class="p">.</span><span class="n">Cast</span><span class="p">&lt;</span><span class="n">DescriptionAttribute</span><span class="p">&gt;()</span>
            <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">();</span>

            <span class="k">return</span> <span class="n">description</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="n">e</span><span class="p">.</span><span class="nf">ToString</span><span class="p">()</span> <span class="p">:</span> <span class="n">description</span><span class="p">.</span><span class="n">Description</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>



<p>The easiest way to use this is expose the Assembly of the project with the views:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">MyProject</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">Assembly</span> <span class="nf">Assembly</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">typeof</span> <span class="p">(</span><span class="n">MyProject</span><span class="p">).</span><span class="n">Assembly</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Then add the below to the DbUp program:</p>

<figure class="highlight"><pre><code class="language-csharp" data-lang="csharp"><span class="n">DeployChanges</span><span class="p">.</span><span class="n">To</span><span class="p">.</span><span class="nf">SqlDatabase</span><span class="p">(</span><span class="n">connectionString</span><span class="p">).</span><span class="nf">GenerateLookupViewsForEnumsIn</span><span class="p">(</span><span class="n">MyProject</span><span class="p">.</span><span class="nf">Assembly</span><span class="p">())</span></code></pre></figure>
    </article>

    <div class="tags">
        <span>Tags:</span>
        


        <span class="tag">
            <a href="https://valantonini.com/tag/dbup

">
    DbUp
</a>
        </span>
        


        <span class="tag">
            <a href="https://valantonini.com/tag/databases

">
    Databases
</a>
        </span>
        


        <span class="tag">
            <a href="https://valantonini.com/tag/csharp

">
    C#
</a>
        </span>
        
    </div>

    
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'arakawa'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    

</div>
                </div>
            </div>
        </div>
    </div>
    <footer>
        <a href="https://valantonini.com/feed.xml" title="rss" target="_blank"><img src="https://valantonini.com/images/rss.png" alt="rss icon" class="icon"></a>
<a href="https://valantonini.com" title="home"><img src="https://valantonini.com/images/logo.png" alt="arakawa icon" class="icon"></a>
<a href="https://www.github.com/valantonini" title="github" target="_blank"><img src="https://valantonini.com/images/github.png" alt="github icon" class="icon"></a>


    </footer>
</div>
<!--<link rel="stylesheet" href="https://valantonini.com/css/main.css">-->
<link rel="stylesheet" href="https://valantonini.com/css/site.css">
<script src="https://valantonini.com/bower_components/bootstrap-sass-official/assets/javascripts/bootstrap.js"></script>
<script src="https://valantonini.com/bower_components/simple-jekyll-search/dest/jekyll-search.js"></script>
<script src="https://valantonini.com/js/site.js"></script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-42499658-1', 'auto');
    ga('send', 'pageview');
</script>

</body>
</html>